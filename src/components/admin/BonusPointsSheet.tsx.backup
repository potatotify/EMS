"use client";

import { useEffect, useState } from "react";
import { FileSpreadsheet, RefreshCw, Plus, X } from "lucide-react";
import LoadingSpinner from "@/components/shared/LoadingSpinner";

interface CustomEntry {
  value: number;
  type: 'points' | 'currency';
  description: string;
}

interface BonusRow {
  employeeId: string;
  employeeName: string;
  date: string; // YYYY-MM-DD
  projectRewardTotal: number;
  projectRewardTotalCurrency: number;
  projectEarned: number;
  projectEarnedCurrency: number;
  projectFine: number;
  projectFineCurrency: number;
  checklistRewardTotal: number;
  checklistRewardTotalCurrency: number;
  checklistEarned: number;
  checklistEarnedCurrency: number;
  checklistFine: number;
  checklistFineCurrency: number;
  taskRewardTotal: number;
  taskRewardTotalCurrency: number;
  taskEarned: number;
  taskEarnedCurrency: number;
  taskFine: number;
  taskFineCurrency: number;
  hackathonEarned: number;
  hackathonEarnedCurrency: number;
  customBonusEntries?: CustomEntry[];
  customFineEntries?: CustomEntry[];
  totalPoints: number;
  totalCurrency: number;
}

export default function BonusPointsSheet() {
  const [rows, setRows] = useState<BonusRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [employeeFilter, setEmployeeFilter] = useState<string>("all");
  const [startDateFilter, setStartDateFilter] = useState<string>("");
  const [endDateFilter, setEndDateFilter] = useState<string>("");
  const [editingCell, setEditingCell] = useState<string | null>(null);
  const [savingCell, setSavingCell] = useState<string | null>(null);

  const fetchRows = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch("/api/admin/bonus-summary", {
        cache: "no-store",
      });
      const data = await response.json();
      if (response.ok) {
        setRows(data.rows || []);
      } else {
        setError(data.error || "Failed to fetch bonus summary");
      }
    } catch (err) {
      console.error("Error fetching bonus summary:", err);
      setError("Error fetching bonus summary");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchRows();
  }, []);

  const handleCustomFieldUpdate = async (
    employeeId: string,
    date: string,
    field: 'customBonus' | 'customFine',
    entries: CustomEntry[]
  ) => {
    const cellKey = `${employeeId}-${date}-${field}`;
    setSavingCell(cellKey);
    
    try {
      const response = await fetch('/api/admin/bonus-summary/custom', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          employeeId,
          date,
          field,
          entries
        })
      });

      if (response.ok) {
        // Update local state
        setRows(prevRows => prevRows.map(row => {
          if (row.employeeId === employeeId && row.date === date) {
            if (field === 'customBonus') {
              return {
                ...row,
                customBonusEntries: entries
              };
            } else {
              return {
                ...row,
                customFineEntries: entries
              };
            }
          }
          return row;
        }));
        setEditingCell(null);
      } else {
        alert('Failed to save custom field');
      }
    } catch (error) {
      console.error('Error saving custom field:', error);
      alert('Error saving custom field');
    } finally {
      setSavingCell(null);
    }
  };

  const employeeOptions = Array.from(
    new Set(rows.map((r) => r.employeeName).filter(Boolean))
  ).sort();

  const filteredRows = rows.filter((row) => {
    if (employeeFilter !== "all" && row.employeeName !== employeeFilter) {
      return false;
    }

    if (startDateFilter) {
      if (row.date < startDateFilter) return false;
    }

    if (endDateFilter) {
      if (row.date > endDateFilter) return false;
    }

    return true;
  });

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <LoadingSpinner />
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
        {error}
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <FileSpreadsheet className="w-6 h-6 text-emerald-600" />
          <h2 className="text-2xl font-bold text-neutral-900">
            Bonus Points Summary
          </h2>
        </div>
        <div className="flex flex-col items-end gap-2">
          {/* Filters */}
          <div className="flex flex-wrap items-center gap-2 justify-end text-xs">
            <select
              value={employeeFilter}
              onChange={(e) => setEmployeeFilter(e.target.value)}
              className="bg-white border border-neutral-300 rounded-lg px-2 py-1 text-xs text-neutral-800 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-200"
            >
              <option value="all">All Employees</option>
              {employeeOptions.map((name) => (
                <option key={name} value={name}>
                  {name}
                </option>
              ))}
            </select>
            <div className="flex items-center gap-1">
              <span className="text-neutral-500">From</span>
              <input
                type="date"
                value={startDateFilter}
                onChange={(e) => setStartDateFilter(e.target.value)}
                className="bg-white border border-neutral-300 rounded-lg px-2 py-1 text-xs text-neutral-800 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-200"
              />
            </div>
            <div className="flex items-center gap-1">
              <span className="text-neutral-500">To</span>
              <input
                type="date"
                value={endDateFilter}
                onChange={(e) => setEndDateFilter(e.target.value)}
                className="bg-white border border-neutral-300 rounded-lg px-2 py-1 text-xs text-neutral-800 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-200"
              />
            </div>
          </div>

          {/* Actions */}
          <div className="flex items-center gap-2">
            <button
              onClick={fetchRows}
              className="inline-flex items-center gap-2 px-4 py-2 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 rounded-lg text-sm font-medium transition-colors"
            >
              <RefreshCw className="w-4 h-4" />
              Refresh
            </button>
          </div>
        </div>
      </div>

      {/* Table */}
      <div className="bg-white rounded-lg border border-neutral-200 shadow-sm overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-neutral-50 border-b border-neutral-200">
                <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-700 uppercase tracking-wider border-r border-neutral-200 min-w-[110px]">
                  Date
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-700 uppercase tracking-wider border-r border-neutral-200 min-w-[160px]">
                  Employee
                </th>
                {/* Project columns */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Project Reward Total (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Project Reward Total (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Project Earned (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Project Earned (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase tracking-wider border-r border-neutral-200 min-w-[100px]">
                  Project Fine (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase tracking-wider border-r border-neutral-200 min-w-[100px]">
                  Project Fine (₹)
                </th>
                {/* Checklist columns */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[140px]">
                  Checklist Reward Total (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[140px]">
                  Checklist Reward Total (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Checklist Earned (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Checklist Earned (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Checklist Fine (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Checklist Fine (₹)
                </th>
                {/* Task columns */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Tasks Reward Total (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Tasks Reward Total (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[110px]">
                  Tasks Earned (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[110px]">
                  Tasks Earned (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase tracking-wider border-r border-neutral-200 min-w-[100px]">
                  Tasks Fine (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase tracking-wider border-r border-neutral-200 min-w-[100px]">
                  Tasks Fine (₹)
                </th>
                {/* Hackathon column */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-yellow-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Hackathon Earned (Pts)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-yellow-700 uppercase tracking-wider border-r border-neutral-200 min-w-[120px]">
                  Hackathon Earned (₹)
                </th>
                {/* Custom Bonus */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-purple-700 uppercase tracking-wider border-r border-neutral-200 min-w-[160px]">
                  Custom Bonus
                </th>
                {/* Custom Fine */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-orange-700 uppercase tracking-wider border-r border-neutral-200 min-w-[160px]">
                  Custom Fine
                </th>
                {/* New columns before Net Points */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider border-r border-neutral-200 min-w-[180px]">
                  Total Points Accumulated
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-blue-700 uppercase tracking-wider border-r border-neutral-200 min-w-[180px]">
                  Total Currency Accumulated (₹)
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[150px]">
                  Total Points Earned
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-emerald-700 uppercase tracking-wider border-r border-neutral-200 min-w-[150px]">
                  Total Currency Earned (₹)
                </th>
                {/* Overall */}
                <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-800 uppercase tracking-wider border-r border-neutral-200 min-w-[110px]">
                  Net Points
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-800 uppercase tracking-wider min-w-[120px]">
                  Net Currency
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-neutral-200">
              {filteredRows.length === 0 ? (
                <tr>
                  <td
                    colSpan={30}
                    className="px-4 py-8 text-center text-neutral-500"
                  >
                    No bonus data found for selected filters
                  </td>
                </tr>
              ) : (
                filteredRows.map((row, index) => (
                  <tr
                    key={`${row.employeeId}-${row.date}-${index}`}
                    className="hover:bg-neutral-50 transition-colors"
                  >
                    <td className="px-4 py-3 text-sm text-neutral-800 border-r border-neutral-200">
                      {row.date}
                    </td>
                    <td className="px-4 py-3 text-sm text-neutral-900 border-r border-neutral-200">
                      {row.employeeName}
                    </td>
                    {/* Project */}
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      {row.projectRewardTotal || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      ₹{row.projectRewardTotalCurrency || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      {row.projectEarned || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      ₹{row.projectEarnedCurrency || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-red-600 border-r border-neutral-200">
                      {row.projectFine || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-red-600 border-r border-neutral-200">
                      ₹{row.projectFineCurrency || 0}
                    </td>
                    {/* Checklist */}
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      {row.checklistRewardTotal || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      ₹{row.checklistRewardTotalCurrency || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      {row.checklistEarned || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      ₹{row.checklistEarnedCurrency || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-red-600 border-r border-neutral-200">
                      {row.checklistFine || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-red-600 border-r border-neutral-200">
                      ₹{row.checklistFineCurrency || 0}
                    </td>
                    {/* Tasks */}
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      {row.taskRewardTotal || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      ₹{row.taskRewardTotalCurrency || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      {row.taskEarned || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200">
                      ₹{row.taskEarnedCurrency || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-red-600 border-r border-neutral-200">
                      {row.taskFine || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-red-600 border-r border-neutral-200">
                      ₹{row.taskFineCurrency || 0}
                    </td>
                    {/* Hackathon */}
                    <td className="px-4 py-3 text-sm text-yellow-700 border-r border-neutral-200">
                      {row.hackathonEarned || 0}
                    </td>
                    <td className="px-4 py-3 text-sm text-yellow-700 border-r border-neutral-200">
                      ₹{row.hackathonEarnedCurrency || 0}
                    </td>
                    {/* Custom Bonus - Editable */}
                    <td className="px-4 py-3 text-sm text-purple-700 border-r border-neutral-200">
                      {editingCell === `${row.employeeId}-${row.date}-customBonus` ? (
                        <CustomFieldEditor
                          entries={row.customBonusEntries || []}
                          onSave={(entries) => {
                            handleCustomFieldUpdate(row.employeeId, row.date, 'customBonus', entries);
                          }}
                          onCancel={() => setEditingCell(null)}
                          saving={savingCell === `${row.employeeId}-${row.date}-customBonus`}
                        />
                      ) : (
                        <div
                          onClick={() => setEditingCell(`${row.employeeId}-${row.date}-customBonus`)}
                          className="cursor-pointer hover:bg-purple-50 p-1 rounded min-h-[40px]"
                          title="Click to edit"
                        >
                          {row.customBonusEntries && row.customBonusEntries.length > 0 ? (
                            <div className="space-y-1">
                              <div className="font-medium">
                                {row.customBonusEntries.filter(e => e.type === 'points').reduce((sum, e) => sum + e.value, 0)} pts
                                {row.customBonusEntries.filter(e => e.type === 'currency').length > 0 && (
                                  <span className="ml-2">+ ₹{row.customBonusEntries.filter(e => e.type === 'currency').reduce((sum, e) => sum + e.value, 0)}</span>
                                )}
                              </div>
                              {row.customBonusEntries.map((entry, idx) => (
                                <div key={idx} className="text-xs text-neutral-500 truncate">
                                  • {entry.value}{entry.type === 'points' ? 'pts' : '₹'}: {entry.description}
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div className="text-neutral-400">Click to add</div>
                          )}
                        </div>
                      )}
                    </td>
                    {/* Custom Fine - Editable */}
                    <td className="px-4 py-3 text-sm text-orange-700 border-r border-neutral-200">
                      {editingCell === `${row.employeeId}-${row.date}-customFine` ? (
                        <CustomFieldEditor
                          entries={row.customFineEntries || []}
                          onSave={(entries) => {
                            handleCustomFieldUpdate(row.employeeId, row.date, 'customFine', entries);
                          }}
                          onCancel={() => setEditingCell(null)}
                          saving={savingCell === `${row.employeeId}-${row.date}-customFine`}
                        />
                      ) : (
                        <div
                          onClick={() => setEditingCell(`${row.employeeId}-${row.date}-customFine`)}
                          className="cursor-pointer hover:bg-orange-50 p-1 rounded min-h-[40px]"
                          title="Click to edit"
                        >
                          {row.customFineEntries && row.customFineEntries.length > 0 ? (
                            <div className="space-y-1">
                              <div className="font-medium">
                                {row.customFineEntries.filter(e => e.type === 'points').reduce((sum, e) => sum + e.value, 0)} pts
                                {row.customFineEntries.filter(e => e.type === 'currency').length > 0 && (
                                  <span className="ml-2">+ ₹{row.customFineEntries.filter(e => e.type === 'currency').reduce((sum, e) => sum + e.value, 0)}</span>
                                )}
                              </div>
                              {row.customFineEntries.map((entry, idx) => (
                                <div key={idx} className="text-xs text-neutral-500 truncate">
                                  • {entry.value}{entry.type === 'points' ? 'pts' : '₹'}: {entry.description}
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div className="text-neutral-400">Click to add</div>
                          )}
                        </div>
                      )}
                    </td>
                    {/* Total Points Accumulated */}
                    <td className="px-4 py-3 text-sm text-blue-700 border-r border-neutral-200 font-medium">
                      {(row.projectRewardTotal || 0) + 
                       (row.checklistRewardTotal || 0) + 
                       (row.taskRewardTotal || 0) + 
                       (row.hackathonEarned || 0)}
                    </td>
                    {/* Total Currency Accumulated */}
                    <td className="px-4 py-3 text-sm text-blue-700 border-r border-neutral-200 font-medium">
                      ₹{(row.projectRewardTotalCurrency || 0) + 
                       (row.checklistRewardTotalCurrency || 0) + 
                       (row.taskRewardTotalCurrency || 0) + 
                       (row.hackathonEarnedCurrency || 0)}
                    </td>
                    {/* Total Points Earned */}
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200 font-medium">
                      {(row.projectEarned || 0) + 
                       (row.checklistEarned || 0) + 
                       (row.taskEarned || 0) + 
                       (row.hackathonEarned || 0)}
                    </td>
                    {/* Total Currency Earned */}
                    <td className="px-4 py-3 text-sm text-emerald-700 border-r border-neutral-200 font-medium">
                      ₹{(row.projectEarnedCurrency || 0) + 
                       (row.checklistEarnedCurrency || 0) + 
                       (row.taskEarnedCurrency || 0) + 
                       (row.hackathonEarnedCurrency || 0)}
                    </td>
                    {/* Net Points - Updated calculation */}
                    <td className="px-4 py-3 text-sm font-semibold border-neutral-200">
                      {(() => {
                        const customBonusPts = (row.customBonusEntries || []).filter(e => e.type === 'points').reduce((sum, e) => sum + e.value, 0);
                        const customFinePts = (row.customFineEntries || []).filter(e => e.type === 'points').reduce((sum, e) => sum + e.value, 0);
                        const netPoints = row.totalPoints + customBonusPts - customFinePts;
                        return (
                          <span
                            className={
                              netPoints > 0
                                ? "text-emerald-700"
                                : netPoints < 0
                                ? "text-red-600"
                                : "text-neutral-700"
                            }
                          >
                            {netPoints}
                          </span>
                        );
                      })()}
                    </td>
                    {/* Net Currency - New column */}
                    <td className="px-4 py-3 text-sm font-semibold border-neutral-200">
                      {(() => {
                        const customBonusCurr = (row.customBonusEntries || []).filter(e => e.type === 'currency').reduce((sum, e) => sum + e.value, 0);
                        const customFineCurr = (row.customFineEntries || []).filter(e => e.type === 'currency').reduce((sum, e) => sum + e.value, 0);
                        const netCurrency = row.totalCurrency + customBonusCurr - customFineCurr;
                        return (
                          <span
                            className={
                              netCurrency > 0
                                ? "text-emerald-700"
                                : netCurrency < 0
                                ? "text-red-600"
                                : "text-neutral-700"
                            }
                          >
                            ₹{netCurrency}
                          </span>
                        );
                      })()}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Summary */}
      <div className="text-sm text-neutral-600">
        Rows: <span className="font-semibold">{filteredRows.length}</span>
      </div>
    </div>
  );
}

// Custom Field Editor Component
function CustomFieldEditor({
  entries,
  onSave,
  onCancel,
  saving
}: {
  entries: CustomEntry[];
  onSave: (entries: CustomEntry[]) => void;
  onCancel: () => void;
  saving: boolean;
}) {
  const [localEntries, setLocalEntries] = useState<CustomEntry[]>(
    entries.length > 0 ? entries : [{ value: 0, type: 'points', description: '' }]
  );

  const addEntry = () => {
    setLocalEntries([...localEntries, { value: 0, type: 'points', description: '' }]);
  };

  const removeEntry = (index: number) => {
    if (localEntries.length > 1) {
      setLocalEntries(localEntries.filter((_, i) => i !== index));
    }
  };

  const updateEntry = (index: number, field: 'value' | 'type' | 'description', value: string | number | 'points' | 'currency') => {
    const updated = [...localEntries];
    if (field === 'value') {
      updated[index].value = Number(value);
    } else if (field === 'type') {
      updated[index].type = value as 'points' | 'currency';
    } else {
      updated[index].description = String(value);
    }
    setLocalEntries(updated);
  };

  return (
    <div className="bg-white border border-neutral-300 rounded-lg p-3 shadow-lg min-w-[280px] max-w-[400px]">
      <div className="space-y-3 max-h-[300px] overflow-y-auto">
        {localEntries.map((entry, index) => (
          <div key={index} className="border border-neutral-200 rounded-lg p-2 space-y-2">
            <div className="flex items-center gap-2">
              <span className="text-xs font-medium text-neutral-500">#{index + 1}</span>
              {localEntries.length > 1 && (
                <button
                  onClick={() => removeEntry(index)}
                  disabled={saving}
                  className="ml-auto text-red-500 hover:text-red-700 disabled:opacity-50"
                  title="Remove entry"
                >
                  <X className="w-4 h-4" />
                </button>
              )}
            </div>
            <div className="flex gap-2">
              <input
                type="number"
                value={entry.value}
                onChange={(e) => updateEntry(index, 'value', e.target.value)}
                placeholder="Amount"
                className="flex-1 px-2 py-1 text-sm border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500"
                disabled={saving}
              />
              <select
                value={entry.type}
                onChange={(e) => updateEntry(index, 'type', e.target.value)}
                className="px-2 py-1 text-sm border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
                disabled={saving}
              >
                <option value="points">Points</option>
                <option value="currency">Currency (₹)</option>
              </select>
            </div>
            <textarea
              value={entry.description}
              onChange={(e) => updateEntry(index, 'description', e.target.value)}
              placeholder="Description..."
              className="w-full px-2 py-1 text-sm border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none"
              rows={2}
              disabled={saving}
            />
          </div>
        ))}
      </div>
      <button
        onClick={addEntry}
        disabled={saving}
        className="w-full mt-2 px-3 py-1 bg-neutral-100 text-neutral-700 text-xs rounded hover:bg-neutral-200 disabled:opacity-50 flex items-center justify-center gap-1"
      >
        <Plus className="w-3 h-3" /> Add Entry
      </button>
      <div className="flex gap-2 mt-3">
        <button
          onClick={() => onSave(localEntries)}
          disabled={saving}
          className="flex-1 px-3 py-1.5 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700 disabled:opacity-50"
        >
          {saving ? 'Saving...' : 'Save All'}
        </button>
        <button
          onClick={onCancel}
          disabled={saving}
          className="flex-1 px-3 py-1.5 bg-neutral-200 text-neutral-700 text-xs rounded hover:bg-neutral-300 disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}


